<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Offline AI Chat</title>
    <style>
        /* Reset and base styles */
        * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
        }

        body {
          font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
          background: linear-gradient(120deg, #f8fafc 0%, #e0e7ff 100%);
          min-height: 100vh;
          color: #232946;
          line-height: 1.5;
        }

        /* Main container */
        .container {
          max-width: 900px;
          margin: 36px auto 0 auto;
          min-height: 80vh;
          display: flex;
          flex-direction: column;
          border-radius: 24px;
          box-shadow: 0 8px 32px rgba(44, 62, 80, 0.14), 0 1.5px 8px rgba(44,62,80,0.05);
          background: rgba(255,255,255,0.85);
          overflow: hidden;
          backdrop-filter: blur(6px);
        }

        /* Header */
        .header {
          background: linear-gradient(90deg, #232946 0%, #3e7cb1 100%);
          color: #fff;
          padding: 38px 40px 18px 40px;
          text-align: center;
          position: sticky;
          top: 0;
          z-index: 10;
          box-shadow: 0 2px 8px rgba(44,62,80,0.10);
        }

        .header h1 {
          font-size: 2.3rem;
          font-weight: 700;
          letter-spacing: 1px;
          margin-bottom: 8px;
          color: #fff;
          text-shadow: 0 2px 8px rgba(44,62,80,0.16);
        }

        .header p {
          font-size: 1.08rem;
          color: #d6e4f0;
          font-weight: 400;
        }

        /* Model selector */
        .model-selector {
          padding: 44px 32px 32px 32px;
          background: rgba(246,248,250,0.8);
          flex: 1;
          display: flex;
          flex-direction: column;
          justify-content: center;
          max-width: 600px;
          margin: 0 auto;
          width: 100%;
          border-radius: 18px;
          box-shadow: 0 2px 16px rgba(62,124,177,0.06);
        }

        .model-selector h3 {
          font-size: 1.5rem;
          font-weight: 700;
          color: #232946;
          margin-bottom: 20px; /* Adjusted margin */
          text-align: center;
          letter-spacing: 0.5px;
          text-shadow: 0 1px 4px rgba(62,124,177,0.06);
        }
        
        /* Model Dropdown Styling */
        #modelDropdown {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.05rem;
            border-radius: 10px;
            border: 2px solid #e0e7ff;
            background-color: rgba(255,255,255,0.75);
            color: #232946;
            margin-bottom: 30px; /* Space before load button */
            cursor: pointer;
            appearance: none; /* Remove default system appearance */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%233E7CB1%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 12px;
        }
        #modelDropdown:focus {
            outline: none;
            border-color: #3e7cb1;
            box-shadow: 0 0 0 2px rgba(62, 124, 177, 0.2);
        }


        /* Load button */
        .load-btn {
          background: linear-gradient(90deg, #232946 0%, #3e7cb1 100%);
          color: #fff;
          border: none;
          padding: 20px 0;
          border-radius: 12px;
          cursor: pointer;
          font-size: 1.12rem;
          font-weight: 700;
          transition: all 0.18s cubic-bezier(.4,0,.2,1);
          width: 100%;
          margin-top: 10px;
          letter-spacing: 0.5px;
          box-shadow: 0 2px 8px rgba(44,62,80,0.09);
        }

        .load-btn:hover:not(:disabled) {
          background: linear-gradient(90deg, #3e7cb1 0%, #232946 100%);
        }

        .load-btn:disabled {
          background: #e3e7ed;
          color: #b0b8c1;
          cursor: not-allowed;
        }

        /* Status */
        .status {
          padding: 18px 32px;
          text-align: center;
          background: #f6f8fa;
          border-bottom: 1px solid #e3e7ed;
          font-size: 1.05rem;
          color: #4f5d75;
          letter-spacing: 0.2px;
        }

        /* Progress Bar */
        .progress {
          padding: 28px 32px;
          background: #ffffff;
          border-bottom: 1px solid #e3e7ed;
          display: none;
        }

        .progress-bar {
          background: #e3e7ed;
          border-radius: 6px;
          height: 12px;
          overflow: hidden;
          margin-bottom: 16px;
        }

        .progress-fill {
          background: linear-gradient(90deg, #3e7cb1 0%, #10b981 100%);
          height: 100%;
          width: 0%;
          transition: width 0.3s cubic-bezier(.4,0,.2,1);
          border-radius: 6px;
        }

        /* Chat container */
        .chat-container {
          display: none; /* Initially hidden, shown by JS */
          flex-direction: column;
          flex: 1;
          min-height: 0; /* Important for flex child to scroll */
          background: rgba(246,248,250,0.8);
        }

        .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: 38px 40px;
          background: transparent;
          min-height: 0; /* Important for flex child to scroll */
        }

        /* Chat bubbles */
        .message {
          margin-bottom: 32px;
          display: flex;
          align-items: flex-start;
          gap: 18px;
          max-width: 100%;
        }

        .message.user {
          flex-direction: row-reverse;
        }

        .message-content {
          background: rgba(255,255,255,0.92);
          padding: 18px 26px;
          border-radius: 20px;
          max-width: 70%;
          word-wrap: break-word;
          white-space: pre-wrap;
          font-size: 1.12rem;
          line-height: 1.6;
          border: 1.5px solid #e3e7ed;
          box-shadow: 0 2px 12px rgba(44,62,80,0.09);
          position: relative;
          transition: background 0.2s;
          backdrop-filter: blur(2px);
        }
         .message-content strong { font-weight: 600; }
         .message-content em { font-style: italic; }
         .message-content pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f0f0f0;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.95em;
            margin: 8px 0;
            border: 1px solid #ddd;
        }


        .message.user .message-content {
          background: linear-gradient(90deg, #232946 0%, #3e7cb1 100%);
          color: #fff;
          border: 1.5px solid #232946;
        }
        .message.user .message-content strong { color: #e0e7ff; } /* Adjust for dark bg */


        .message-avatar {
          width: 42px;
          height: 42px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 1.5rem;
          flex-shrink: 0;
          background: linear-gradient(90deg, #e0e7ff 0%, #f0f4fa 100%);
          border: 1.5px solid #3e7cb1;
          box-shadow: 0 2px 8px rgba(62,124,177,0.07);
        }

        .message.user .message-avatar {
          background: linear-gradient(90deg, #232946 0%, #3e7cb1 100%);
          color: #fff;
          border: 1.5px solid #232946;
        }

        /* Typing animation */
        .typing { /* Applied to message-content when bot is "typing" */
          animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }

        /* Streaming cursor */
        .streaming { /* Applied to message-content during streaming */
          position: relative;
        }

        .message.bot .message-content.streaming::after {
          content: '▋';
          animation: blink 1s infinite;
          color: #232946; /* Cursor color for bot messages */
          display: inline-block; /* Ensure it's on the same line */
          margin-left: 2px; /* Small space before cursor */
        }
        .message.user .message-content.streaming::after { /* Should not happen on user usually */
          color: #fff; /* Cursor color for user messages if ever needed */
        }


        @keyframes blink {
          0%, 50% { opacity: 1; }
          51%, 100% { opacity: 0; }
        }

        /* Chat input area container */
        .chat-input {
          padding: 20px 40px; /* Reduced padding slightly */
          background: rgba(255,255,255,0.95);
          border-top: 1px solid #e3e7ed;
          position: sticky; /* Make input area sticky */
          bottom: 0;
          z-index: 2;
          backdrop-filter: blur(3px);
        }

        .input-container {
          display: flex;
          gap: 18px;
          align-items: flex-end; /* Align items to bottom for multi-line textareas */
          max-width: 100%;
        }

        .chat-input textarea {
          flex: 1;
          resize: none; /* Disable manual resize, let it grow with content */
          border: 1.5px solid #e3e7ed;
          border-radius: 16px;
          padding: 16px 22px;
          font-family: inherit;
          font-size: 1.12rem;
          min-height: 56px; /* Based on padding + line-height */
          max-height: 160px; /* Max height before scrollbar appears */
          background: #f6f8fa;
          transition: border-color 0.2s, background-color 0.2s;
          box-shadow: 0 1px 4px rgba(44,62,80,0.04);
          line-height: 1.4; /* Adjust for better multi-line appearance */
          overflow-y: auto; /* Show scrollbar if max-height is exceeded */
        }

        .chat-input textarea:focus {
          outline: none;
          border-color: #3e7cb1;
          background: #fff;
        }

        .chat-input textarea::placeholder {
          color: #b0b8c1;
        }

        .send-btn {
          background: linear-gradient(90deg, #232946 0%, #3e7cb1 100%);
          color: #fff;
          border: none;
          height: 56px; /* Match textarea min-height */
          padding: 0 32px; /* Adjust padding for fixed height */
          border-radius: 16px;
          cursor: pointer;
          font-size: 1.12rem;
          font-weight: 700;
          transition: all 0.18s cubic-bezier(.4,0,.2,1);
          flex-shrink: 0;
          box-shadow: 0 2px 8px rgba(44,62,80,0.09);
          display: flex; /* For centering icon if added later */
          align-items: center;
          justify-content: center;
        }

        .send-btn:hover:not(:disabled) {
          background: linear-gradient(90deg, #3e7cb1 0%, #232946 100%);
        }

        .send-btn:disabled {
          background: #e3e7ed;
          color: #b0b8c1;
          cursor: not-allowed;
        }

        /* Performance tip */
        .performance-tip {
          background: linear-gradient(90deg, #e0e7ff 0%, #f6f8fa 100%);
          border: 1.5px solid #e3e7ed;
          border-radius: 12px;
          padding: 20px;
          margin-top: 30px;
          font-size: 1.08rem;
          color: #4f5d75;
          line-height: 1.5;
          box-shadow: 0 1px 6px rgba(44,62,80,0.05);
        }

        .performance-tip strong {
          color: #232946;
        }

        /* CAG Controls Specific Styles */
        #cagControlsContainer {
            padding: 20px 40px; /* Match horizontal padding of chat-input */
            background: rgba(240, 244, 250, 0.85); /* Slightly different background */
            border-top: 1px solid #e3e7ed;
        }

        #cagControlsContainer details {
            border: 1.5px solid #dbeafe; /* Softer border */
            border-radius: 12px;
            padding: 18px 22px;
            background-color: rgba(255,255,255,0.9); /* Brighter background for content */
            box-shadow: 0 2px 8px rgba(62,124,177,0.06);
        }

        #cagControlsContainer summary {
            cursor: pointer;
            font-weight: 600;
            color: #232946;
            font-size: 1.08rem; /* Slightly larger */
            margin-bottom: 12px; /* Space before content when open */
            list-style-position: inside; /* Better alignment of marker */
            transition: color 0.2s;
        }
        #cagControlsContainer summary:hover {
            color: #3e7cb1;
        }

        #cagControlsContainer summary:focus {
            outline: 2px solid transparent; /* Remove default, or use custom */
            outline-offset: 2px;
        }
        
        #cagControlsContainer summary::marker {
            color: #3e7cb1;
            font-size: 0.9em; /* Smaller marker */
        }

        #cagDatasetInput {
            width: 100%;
            margin-bottom: 15px; /* Increased margin */
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.98rem; /* Slightly larger mono font */
            padding: 14px 20px; 
            border: 1.5px solid #dbeafe; 
            border-radius: 10px; 
            min-height: 100px; 
            background: #f9fafc; /* Lighter background */
            box-shadow: inset 0 1px 3px rgba(44,62,80,0.05);
            color: #232946;
            line-height: 1.5;
        }

        #cagDatasetInput:focus {
            outline: none;
            border-color: #3e7cb1;
            background: #fff;
            box-shadow: 0 0 0 2px rgba(62, 124, 177, 0.2); /* Focus ring */
        }

        .cag-btn {
            background: #f0f4fa;
            color: #3e7cb1;
            border: 1.5px solid #dbeafe;
            padding: 10px 20px; /* Slightly larger buttons */
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.95rem; /* Slightly larger font */
            font-weight: 600;
            transition: all 0.18s cubic-bezier(.4,0,.2,1);
            margin-right: 10px;
            box-shadow: 0 1px 4px rgba(44,62,80,0.06);
        }

        .cag-btn:hover:not(:disabled) {
            background: #e0e7ff;
            border-color: #3e7cb1;
            box-shadow: 0 2px 6px rgba(44,62,80,0.08);
        }

        .cag-btn:disabled {
            background: #e3e7ed;
            color: #b0b8c1;
            cursor: not-allowed;
            border-color: #e3e7ed;
        }
        
        #clearCAGDatasetBtn.cag-btn { /* Specific for clear button if needed */
            background: #ffebee; /* Light red for destructive action hint */
            color: #c62828;
            border-color: #ffcdd2;
        }
        #clearCAGDatasetBtn.cag-btn:hover:not(:disabled) {
            background: #ffcdd2;
            border-color: #c62828;
        }


        #cagStatus {
            font-size: 0.95rem; /* Slightly larger */
            margin-top: 15px; /* Increased margin */
            color: #4f5d75; 
            font-style: normal; /* Less obtrusive default style */
            font-weight: 500;
            padding: 8px 12px;
            border-radius: 6px;
            background-color: transparent; /* Default, JS can change it */
        }
        /* JS will change textContent and potentially background/color for status messages */


        /* Responsive design */
        @media (max-width: 768px) {
          .container {
            border-radius: 0;
            margin: 0;
            box-shadow: none;
          }

          .header {
            padding: 22px 12px 12px 12px;
          }

          .header h1 {
            font-size: 1.3rem;
          }

          .model-selector {
            padding: 18px 8px 18px 8px;
            border-radius: 0;
          }
           #modelDropdown {
            font-size: 1rem;
            padding: 10px 12px;
            background-position: right 10px center;
          }


          .chat-messages {
            padding: 16px 12px; /* Slightly more horizontal padding */
          }
          
          .message-content {
            max-width: 85%; /* Give a bit more space */
            font-size: 1rem;
            padding: 13px 16px;
          }
          .message-avatar {
            width: 36px;
            height: 36px;
            font-size: 1.3rem;
          }


          .chat-input {
            padding: 12px; /* Reduced padding */
          }
          #cagControlsContainer {
            padding: 12px; /* Reduced padding */
          }
          #cagControlsContainer details {
            padding: 12px 15px;
          }
          #cagDatasetInput {
            padding: 10px 14px;
            font-size: 0.9rem;
          }
          .cag-btn {
            padding: 8px 14px;
            font-size: 0.85rem;
          }


          .input-container {
            gap: 8px;
          }
          .chat-input textarea {
            min-height: 48px;
            padding: 12px 16px;
            font-size: 1rem;
          }
          .send-btn {
            height: 48px;
            padding: 0 20px;
            font-size: 1rem;
          }

        }

        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar,
        .chat-input textarea::-webkit-scrollbar {
          width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .chat-input textarea::-webkit-scrollbar-track {
          background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .chat-input textarea::-webkit-scrollbar-thumb {
          background: #dbeafe; /* Softer scrollbar thumb */
          border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .chat-input textarea::-webkit-scrollbar-thumb:hover {
          background: #b0b8c1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI Assistant</h1>
            <p>Powered by local AI models</p>
        </div>
        
        <div class="model-selector" id="modelSelector">
            <h3>Choose AI Model</h3>
            <!-- Replaced model cards with a dropdown -->
            <select id="modelDropdown">
                <option value="" disabled selected>Select a model...</option>
                <option value="TinyLlama-1.1B-Chat-v1.0-q4f16_1-MLC">TinyLlama 1.1B (Fastest, ~650MB)</option>
                <option value="gemma-2b-it-q4f16_1-MLC">Gemma 2B IT (Fast, ~1.4GB)</option>
                <option value="Phi-3-mini-4k-instruct-q4f16_1-MLC">Phi-3 Mini 4k Instruct (Medium, ~2.1GB)</option>
            </select>

            <button class="load-btn" id="loadBtn" disabled>Select a model to continue</button>
            
            <div class="performance-tip">
                <strong>Performance Tip:</strong> Enable WebGPU in Chrome (chrome://flags) for significantly better performance with larger models.
            </div>
        </div>

        <div class="status" id="status">Select a model to start chatting</div>

        <div class="progress" id="progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressText" style="text-align: center; margin-top: 12px; color: #4f5d75; font-size: 0.95rem;">Ready to load...</div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be appended here by JS -->
            </div>

            <!-- CAG Controls HTML -->
            <div id="cagControlsContainer" style="display: none;">
                <details>
                    <summary>Cache-Augmented Generation (CAG) Settings</summary>
                    <div style="padding-top: 10px;">
                        <p style="font-size: 0.95rem; margin-bottom: 12px; color: #4f5d75; line-height: 1.5;">
                            Preload static data (e.g., FAQs, document snippets) into the model's context. 
                            The model will then primarily use this data to answer your queries.
                            <br><strong>Note:</strong> Large datasets may impact performance or exceed context limits. Keep it concise.
                        </p>
                        <textarea id="cagDatasetInput" rows="5" placeholder="Paste your static dataset here... (e.g., FAQ content, document excerpts)"></textarea>
                        <button id="loadCAGDatasetBtn" class="cag-btn">Load Dataset</button>
                        <button id="clearCAGDatasetBtn" class="cag-btn" style="display: none;">Clear Dataset</button>
                        <p id="cagStatus"></p>
                    </div>
                </details>
            </div>
            <!-- End of CAG Controls HTML -->

            <div class="chat-input">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="Type your message..." 
                        rows="1"
                    ></textarea>
                    <button class="send-btn" id="sendBtn">Send</button>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    class SimpleAIChat {
        constructor() {
            this.engine = null;
            this.selectedModel = null;
            this.modelLoaded = false;
            this.isGenerating = false;
            this.conversationHistory = [];
            this.cagDataset = '';
            this.initializeElements();
            this.setupEventListeners();
            this.setupInputAutosize(); // For textarea auto-resize
        }

        initializeElements() {
            this.elements = {
                modelSelector: document.getElementById('modelSelector'),
                // modelCards: document.querySelectorAll('.model-card'), // Removed
                modelDropdown: document.getElementById('modelDropdown'), // Added
                loadBtn: document.getElementById('loadBtn'),
                status: document.getElementById('status'),
                progress: document.getElementById('progress'),
                progressFill: document.getElementById('progressFill'),
                progressText: document.getElementById('progressText'),
                chatContainer: document.getElementById('chatContainer'),
                chatMessages: document.getElementById('chatMessages'),
                messageInput: document.getElementById('messageInput'),
                sendBtn: document.getElementById('sendBtn'),

                // CAG Elements
                cagControlsContainer: document.getElementById('cagControlsContainer'),
                cagDatasetInput: document.getElementById('cagDatasetInput'),
                loadCAGDatasetBtn: document.getElementById('loadCAGDatasetBtn'),
                clearCAGDatasetBtn: document.getElementById('clearCAGDatasetBtn'),
                cagStatus: document.getElementById('cagStatus')
            };
        }

        setupEventListeners() {
            // Listen to dropdown change event
            if (this.elements.modelDropdown) {
                this.elements.modelDropdown.addEventListener('change', (event) => this.selectModelFromDropdown(event.target));
            } else {
                console.warn("Model dropdown not found");
            }

            this.elements.loadBtn.addEventListener('click', () => this.loadModel());
            this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
            
            this.elements.messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    this.sendMessage();
                }
            });

            // CAG Event Listeners
            if (this.elements.loadCAGDatasetBtn) {
                this.elements.loadCAGDatasetBtn.addEventListener('click', () => this.loadCAGDataset());
            } else {
                console.warn("CAG Load button not found");
            }
            if (this.elements.clearCAGDatasetBtn) {
                this.elements.clearCAGDatasetBtn.addEventListener('click', () => this.clearCAGDataset());
            } else {
                console.warn("CAG Clear button not found");
            }
        }
        
        setupInputAutosize() {
            const messageInput = this.elements.messageInput;
            if (!messageInput) return;

            // const initialHeight = messageInput.scrollHeight; // Not strictly needed here
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto'; // Reset height
                let newHeight = messageInput.scrollHeight;
                const maxHeight = parseInt(window.getComputedStyle(messageInput).maxHeight);
                
                if (newHeight > maxHeight) {
                    newHeight = maxHeight;
                    messageInput.style.overflowY = 'auto';
                } else {
                    messageInput.style.overflowY = 'hidden';
                }
                messageInput.style.height = `${newHeight}px`;
            });
            // Initial check
            messageInput.style.height = 'auto';
            const currentScrollHeight = messageInput.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(messageInput).maxHeight);
            if (currentScrollHeight > maxHeight) {
                 messageInput.style.overflowY = 'auto';
                 messageInput.style.height = `${maxHeight}px`;
            } else {
                messageInput.style.overflowY = 'hidden';
                messageInput.style.height = `${currentScrollHeight}px`;
            }
        }

        selectModelFromDropdown(dropdownElement) {
            const selectedOption = dropdownElement.options[dropdownElement.selectedIndex];
            if (selectedOption && selectedOption.value) {
                this.selectedModel = selectedOption.value;
                // Extract model name from text, removing size/speed info for button
                const modelNameForButton = selectedOption.text.split('(')[0].trim(); 
                this.elements.loadBtn.disabled = false;
                this.elements.loadBtn.textContent = `Load ${modelNameForButton}`;
            } else {
                this.selectedModel = null;
                this.elements.loadBtn.disabled = true;
                this.elements.loadBtn.textContent = `Select a model to continue`;
            }
        }


        updateStatus(message, isError = false) {
            this.elements.status.textContent = message;
            this.elements.status.style.color = isError ? '#c62828' : '#4f5d75';
        }

        updateProgress(progress, text) {
            this.elements.progressFill.style.width = `${progress}%`;
            this.elements.progressText.textContent = text;
        }

        async loadModel() {
            if (!this.selectedModel) return;

            this.elements.loadBtn.disabled = true;
            this.elements.progress.style.display = 'block';
            this.updateStatus('Loading AI model...');
            this.updateProgress(0, 'Initializing...');

            try {
                const { CreateMLCEngine } = await import('https://esm.run/@mlc-ai/web-llm');
                
                this.updateProgress(20, 'Creating AI engine...');
                
                const engineConfig = {
                    initProgressCallback: (report) => {
                        console.log('WebLLM Progress:', report);
                        const progress = Math.min(95, 20 + (report.progress || 0) * 75); // Scale 0-1 to 0-75
                        this.updateProgress(progress, report.text || 'Loading model data...');
                    }
                };

                this.engine = await CreateMLCEngine(this.selectedModel, engineConfig);

                this.updateProgress(98, 'Warming up model...');
                
                try {
                    await this.engine.chat.completions.create({
                        messages: [{ role: "user", content: "Hi" }],
                        max_tokens: 1, // Minimal generation for warmup
                        temperature: 0.5,
                    });
                } catch (warmupError) {
                    console.warn('Warmup failed, but continuing:', warmupError);
                }

                this.updateProgress(100, 'Model loaded successfully!');
                this.modelLoaded = true;
                
                setTimeout(() => {
                    this.elements.modelSelector.style.display = 'none';
                    this.elements.progress.style.display = 'none';
                    this.elements.chatContainer.style.display = 'flex';
                    if (this.elements.cagControlsContainer) { 
                        this.elements.cagControlsContainer.style.display = 'block';
                    }
                    this.updateStatus('Model loaded! Start chatting below.');
                    
                    this.addMessage('bot', 'Hello! I\'m your offline AI assistant running entirely in your browser. How can I help you today?');
                    this.elements.messageInput.focus();
                }, 1000);

            } catch (error) {
                console.error('Error loading model:', error);
                this.updateStatus(`❌ Error: ${error.message}`, true);
                this.elements.loadBtn.disabled = false;
                this.elements.progress.style.display = 'none';
                
                let helpText = 'Try using TinyLlama for fastest performance, or ensure you have enough memory (8GB+ RAM recommended for larger models).';
                if (error.message.includes('fetch') || error.message.includes('network')) {
                    helpText = 'Check your internet connection for initial model download.';
                }
                
                alert(`Failed to load model: ${error.message}\n\n${helpText}`);
            }
        }

        async sendMessage() {
            if (!this.modelLoaded || this.isGenerating) return;

            const message = this.elements.messageInput.value.trim();
            if (!message) return;

            this.addMessage('user', message);
            this.elements.messageInput.value = '';
            // Reset textarea height after sending message
            this.elements.messageInput.style.height = 'auto'; 
            const newHeight = this.elements.messageInput.scrollHeight;
            const maxHeight = parseInt(window.getComputedStyle(this.elements.messageInput).maxHeight);
            this.elements.messageInput.style.height = `${Math.min(newHeight, maxHeight)}px`;
            if (newHeight > maxHeight) {
                this.elements.messageInput.style.overflowY = 'auto';
            } else {
                this.elements.messageInput.style.overflowY = 'hidden';
            }


            this.isGenerating = true;
            this.elements.sendBtn.disabled = true;

            this.conversationHistory.push({ role: "user", content: message });
            
            const maxHistoryMessages = 6; 
            if (this.conversationHistory.length > maxHistoryMessages) {
                let systemMessage = null;
                if (this.conversationHistory.length > 0 && this.conversationHistory[0].role === "system") {
                    systemMessage = this.conversationHistory.shift();
                }
                this.conversationHistory = this.conversationHistory.slice(-maxHistoryMessages);
                if(systemMessage) {
                    this.conversationHistory.unshift(systemMessage);
                }
            }

            const responseId = this.addMessage('bot', '', true); 
            const responseElement = document.querySelector(`[data-id="${responseId}"] .message-content`);
            responseElement.classList.add('streaming'); 

            let messagesToSend = [];
            const systemPrompt = `You are an AI assistant. Use the following DOCUMENT CONTEXT exclusively to answer the user's question. If the answer is not found within the DOCUMENT CONTEXT, clearly state that the information is not available in the provided document. Do not use any external knowledge.\n\nDOCUMENT CONTEXT:\n---\n${this.cagDataset}\n---\nBased *only* on the DOCUMENT CONTEXT provided above, answer the user's question.`;

            if (this.cagDataset) {
                messagesToSend.push({ 
                    role: "system", 
                    content: systemPrompt
                });
            }
            messagesToSend = messagesToSend.concat(this.conversationHistory);

            try {
                 // Adjusted max_tokens based on selectedModel string content
                let maxTokens = 180; // Default
                if (this.selectedModel) { // Check if selectedModel is defined
                    if (this.selectedModel.includes('TinyLlama')) maxTokens = 250;
                    else if (this.selectedModel.includes('gemma')) maxTokens = 220;
                    else if (this.selectedModel.includes('Phi-3')) maxTokens = 200;
                }


                const completion = await this.engine.chat.completions.create({
                    messages: messagesToSend,
                    temperature: this.cagDataset ? 0.3 : 0.6, 
                    max_tokens: maxTokens,
                    stream: true,
                });

                let fullResponse = '';
                for await (const chunk of completion) {
                    const content = chunk.choices[0]?.delta?.content || '';
                    if (content) {
                        fullResponse += content;
                        let currentText = fullResponse;
                        currentText = currentText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                                 .replace(/\*(.*?)\*/g, '<em>$1</em>');
                        responseElement.innerHTML = currentText; 
                        this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                    }
                }
                responseElement.innerHTML = fullResponse.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                                                        .replace(/\*(.*?)\*/g, '<em>$1</em>');


                this.conversationHistory.push({ role: "assistant", content: fullResponse });

            } catch (error) {
                console.error('Generation error:', error);
                responseElement.innerHTML = '❌ Sorry, I encountered an error. This might be due to the context size if a large dataset was loaded. Please try again or clear the dataset.';
            }

            responseElement.classList.remove('streaming');
            responseElement.classList.remove('typing'); 
            this.isGenerating = false;
            this.elements.sendBtn.disabled = false;
            this.elements.messageInput.focus();
        }

        addMessage(sender, text, isTyping = false) {
            const messageId = Date.now() + Math.random().toString(36).substr(2, 9);
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`; 
            messageDiv.dataset.id = messageId;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? '👤' : (sender === 'system' ? '⚙️' : '🤖');

            const content = document.createElement('div');
            content.className = 'message-content';
            if (isTyping && sender === 'bot') {
                content.classList.add('typing'); 
            }
            
            if (!isTyping || text) {
                 text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                           .replace(/\*(.*?)\*/g, '<em>$1</em>');
                content.innerHTML = text;
            }


            messageDiv.appendChild(avatar);
            messageDiv.appendChild(content);
            
            this.elements.chatMessages.appendChild(messageDiv);
            this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            
            return messageId;
        }
        
        loadCAGDataset() {
            if (!this.elements.cagDatasetInput || !this.elements.cagStatus || !this.elements.clearCAGDatasetBtn || !this.elements.loadCAGDatasetBtn) {
                console.error("CAG UI elements not found in loadCAGDataset");
                return;
            }
            const dataset = this.elements.cagDatasetInput.value.trim();
            if (dataset) {
                this.cagDataset = dataset;
                this.elements.cagStatus.textContent = 'Dataset loaded. It will be used for subsequent queries.';
                this.elements.cagStatus.style.color = '#10b981'; // Green
                this.elements.cagStatus.style.backgroundColor = '#e6f7f0';
                this.elements.cagStatus.style.border = '1px solid #10b981';

                this.elements.clearCAGDatasetBtn.style.display = 'inline-block';
                this.elements.loadCAGDatasetBtn.textContent = 'Reload Dataset';
                console.log("CAG Dataset loaded. Length:", dataset.length);
            } else {
                this.cagDataset = '';
                this.elements.cagStatus.textContent = 'Dataset input is empty. No dataset active.';
                this.elements.cagStatus.style.color = '#f59e0b'; // Orange
                this.elements.cagStatus.style.backgroundColor = '#fff8e1';
                this.elements.cagStatus.style.border = '1px solid #f59e0b';

                this.elements.clearCAGDatasetBtn.style.display = 'none';
                this.elements.loadCAGDatasetBtn.textContent = 'Load Dataset';
            }
        }

        clearCAGDataset() {
            if (!this.elements.cagDatasetInput || !this.elements.cagStatus || !this.elements.clearCAGDatasetBtn || !this.elements.loadCAGDatasetBtn) {
                console.error("CAG UI elements not found in clearCAGDataset");
                return;
            }
            this.cagDataset = '';
            this.elements.cagDatasetInput.value = '';
            this.elements.cagStatus.textContent = 'Dataset cleared from context.';
            this.elements.cagStatus.style.color = '#10b981'; // Green
            this.elements.cagStatus.style.backgroundColor = '#e6f7f0';
            this.elements.cagStatus.style.border = '1px solid #10b981';

            this.elements.clearCAGDatasetBtn.style.display = 'none';
            this.elements.loadCAGDatasetBtn.textContent = 'Load Dataset';
            console.log("CAG Dataset cleared.");
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new SimpleAIChat();
    });
</script>
</body>
</html>